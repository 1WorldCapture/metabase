# Triggers Percy job on push to master and release branches to create baseline screenshots
name: Percy

on:
  workflow_run:
    workflows: [Uberjar]
    types:
      - completed
    branches:
      - workflow_run
      - "release-**"

jobs:
  percy:
    timeout-minutes: 30
    runs-on: buildjet-4vcpu-ubuntu-2004
    needs: build
    steps:
      - name: Check out the code
        uses: actions/checkout@v3
      - name: Set required status check
        uses: ./.github/actions/set-required-status-check
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - name: Prepare cypress environment
        uses: ./.github/actions/prepare-cypress

      - uses: actions/download-artifact@v2
        name: Retrieve uberjar artifact
        with:
          name: metabase-oss-uberjar
      - name: Get the version info
        run: |
          jar xf target/uberjar/metabase.jar version.properties
          mv version.properties resources/
      - name: Run maildev
        run: docker run -d -p 80:80 -p 25:25 maildev/maildev:1.1.0
      - name: Percy Test
        run: yarn run test-visual-no-build
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
        if: env.PERCY_TOKEN != null
      - name: Update required status check
        uses: ./.github/actions/update-required-status-check
