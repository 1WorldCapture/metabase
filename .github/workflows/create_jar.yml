name: Create Uberjar

on:
  workflow_run:
    workflows: [E2E Tests, Uberjar]
    types: [completed]
    branches: [gha-test]

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    strategy:
      matrix:
        edition: [ee, oss]
    env:
      MB_EDITION: ${{ matrix.edition }}
      INTERACTIVE: false
    steps:
      - name: Check out the code
        uses: actions/checkout@v2
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - name: Build
        run: ./bin/build
      - name: Prepare uberjar artifact
        uses: ./.github/actions/prepare-uberjar-artifact
      - name: Mark with the commit hash
        run: git rev-parse --short HEAD > COMMIT-ID
        shell: bash
      - name: Calculate SHA256 checksum
        run: sha256sum ./target/uberjar/metabase.jar > SHA256.sum
        shell: bash
      - name: Upload JARs as artifact
        uses: actions/upload-artifact@v2
        with:
          name: metabase-${{ matrix.edition }}-uberjar
          path: |
            ./target/uberjar/metabase.jar
            ./COMMIT-ID
            ./SHA256.sum